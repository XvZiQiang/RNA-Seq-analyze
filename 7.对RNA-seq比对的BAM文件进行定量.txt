cd /mnt/c/Users/XZQ/Desktop/NCBI/Plant\ communications_RNA_seq/rna-seq-project
conda activate rna-seq

ls

ls bam


# éå† bam ç›®å½•ä¸‹æ‰€æœ‰ bam æ–‡ä»¶ï¼Œå¹¶æå–æ–‡ä»¶åä¸ºsampleï¼Œå¯¼å‡º{sample}.sorted.bamï¼Œ24æ˜¯çº¿ç¨‹æ•°
for bamfile in bam/*.bam; do
    sample=$(basename "$bamfile" .bam)
    # æ’åº BAM
    samtools sort -@ 24 -o bam/${sample}.sorted.bam "$bamfile"

mkdir counts

#å•ç‹¬å–ä¸€ä¸ªæ ·æœ¬.sorted.bamæ–‡ä»¶ï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦æ­£ç¡®ç”Ÿæˆ reads-to-gene BAMï¼Œå•çº¿ç¨‹
featureCounts -a reference/Arabidopsis_thaliana.TAIR10.62.gtf \
-t exon -g gene_id \
-Q 10 --primary -s 0 -F gtf -p -T 1 \
-o counts/debug.txt \
-R BAM bam/WT_repl1.sorted.bam


æ£€æŸ¥é‡å¤è®¡æ•°
samtools view counts/WT_repl1.sorted.bam.featureCounts.bam | cut -f1 | sort | uniq -c | sort -nr | head


samtools view â†’ æŸ¥çœ‹ BAM å†…å®¹
cut -f1 â†’ æå– read åç§°
sort | uniq -c â†’ ç»Ÿè®¡æ¯æ¡ read å‡ºç°æ¬¡æ•°
sort -nr â†’ æŒ‰æ¬¡æ•°ä»å¤§åˆ°å°æ’åº
head â†’ æŸ¥çœ‹å‡ºç°æ¬¡æ•°æœ€å¤šçš„å‡ æ¡ read


è¯´æ˜é”™è¯¯ï¼Œé‡å¤è®¡ç®—äº†reads









æ ¹æ®å‚è€ƒåŸºå› ç»„GTFæ–‡ä»¶å’Œ{sample}.sorted.bamæ–‡ä»¶å¯¼å‡ºåŸºå› è¡¨è¾¾é‡
featureCounts -a reference/Arabidopsis_thaliana.TAIR10.62.gtf -t exon -Q 10 --countReadPairs --primary -s 0 -F gtf -g gene_id -p -T 24 -o counts/expr_matrix.txt bam/*.sorted.bam


æ ¹æ®å‚è€ƒåŸºå› ç»„GTFæ–‡ä»¶å¯¼å‡ºåŸºå› è¡¨è¾¾é‡


featureCounts
ğŸ‘‰ æ¥è‡ª Subread è½¯ä»¶åŒ…çš„å‘½ä»¤ï¼Œç”¨äºç»Ÿè®¡ BAM æ–‡ä»¶ä¸­æ¯ä¸ªåŸºå› çš„ reads æ•°é‡ï¼ˆå³ åŸºå› è¡¨è¾¾å®šé‡ï¼‰

-a reference/Arabidopsis_thaliana.TAIR10.62.gtf
ğŸ‘‰ æŒ‡å®šæ³¨é‡Šæ–‡ä»¶

-t exon
æŒ‡å®šå¤–æ˜¾å­ï¼ŒæŒ‡å®šè¦è®¡æ•°çš„ feature ç±»å‹

-Q 10
è®¾ç½® æœ€å°æ¯”å¯¹è´¨é‡ï¼ˆmapping qualityï¼‰é˜ˆå€¼ä¸º 10ã€‚æ¯”å¯¹è´¨é‡ä½äº 10 çš„ reads ä¼šè¢«ä¸¢å¼ƒã€‚è¿™èƒ½æ’é™¤é‚£äº›æ¯”å¯¹åˆ°å¤šä¸ªä½ç½®æˆ–é”™è¯¯æ¯”å¯¹çš„ readsã€‚

--countReadPairs
å¿…é¡»åŠ ä¸Šï¼Œå¦åˆ™è¡¨è¾¾é‡ä¼šç¿»å€ï¼Œå’Œ-pä¸€èµ·å‘æŒ¥ä½œç”¨ï¼›å¯¹ paired-end æ•°æ®ï¼Œæ¯å¯¹ readsï¼ˆread1 + read2ï¼‰åªè®¡ä½œ ä¸€ä¸ªå•ä½ã€‚
ç›¸å½“äºå‘Šè¯‰ featureCountsï¼šâ€œè¿™ä¸¤ä¸ª mate å±äºåŒä¸€åˆ†å­ï¼Œä¸è¦ç®—ä¸¤æ¬¡ã€‚â€

--primary
å¼ºåˆ¶è¯»å–ä¸»ä½“éƒ¨åˆ†ï¼›å¦‚æœ reads æ¯”å¯¹åˆ°å¤šä¸ªä½ç½®ï¼Œåªæœ‰ä¸€ä¸ªæ˜¯ primaryã€‚è¿™ä¸ªå‚æ•°èƒ½æœ‰æ•ˆé˜²æ­¢é‡å¤è®¡æ•°

-s 0
é»˜è®¤é“¾ï¼Œä¸åŒºåˆ†é“¾ç‰¹å¼‚æ€§ï¼ˆunstrandedï¼‰ã€‚-s 0ï¼šä¸åŒºåˆ†æ­£è´Ÿé“¾ï¼›-s 1ï¼šé“¾ç‰¹å¼‚æ­£é“¾ï¼›-s 2ï¼šé“¾ç‰¹å¼‚è´Ÿé“¾

-F gtf
ğŸ‘‰ æŒ‡å®šæ³¨é‡Šæ–‡ä»¶çš„æ ¼å¼ä¸º GTFï¼ˆè€Œä¸æ˜¯ GFFï¼‰

-g gene_id
ğŸ‘‰ å‘Šè¯‰ featureCounts ç”¨æ³¨é‡Šæ–‡ä»¶ä¸­å“ªä¸ªå­—æ®µæ¥åŒºåˆ†ä¸åŒåŸºå› ã€‚

-p
ğŸ‘‰ è¡¨ç¤ºè¿™æ˜¯ åŒç«¯æµ‹åºæ•°æ®ï¼ˆpaired-endï¼‰ã€‚
å¯ç”¨ paired-end æ¨¡å¼ã€‚
è¿™å‘Šè¯‰ featureCounts è¾“å…¥æ–‡ä»¶æ˜¯æˆå¯¹çš„ readsã€‚
å®ƒä¼šæ£€æŸ¥ read1/read2 æ˜¯å¦éƒ½æ¯”å¯¹æˆåŠŸã€æ˜¯å¦åˆç†é…å¯¹ã€‚
ğŸ’¡ æ³¨æ„ï¼š-p å¿…é¡»é…åˆ --countReadPairsï¼Œå¦åˆ™æ¯ä¸ª mate ä¼šè®¡ä¸¤æ¬¡ã€‚

-T 24
ğŸ‘‰ ä½¿ç”¨ 24 ä¸ªçº¿ç¨‹ åŠ é€Ÿè®¡æ•°è¿‡ç¨‹ï¼ˆå¤šæ ¸ CPU å¹¶è¡Œï¼‰

-o counts/expr_matrix.txt
ğŸ‘‰ è¾“å‡ºæ–‡ä»¶è·¯å¾„ä¸åç§°

bam/*.sorted.bam
ğŸ‘‰ è¾“å…¥æ‰€æœ‰æ¯”å¯¹åçš„ BAM æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯ä½ å‰é¢ç”Ÿæˆçš„å¤šä¸ªæ ·æœ¬


ls

æ‰“å¼€æ£€æŸ¥æ–‡ä»¶
less -S counts/expr_matrix.txt          lessï¼šåˆ†é¡µæ˜¾ç¤ºæ–‡æœ¬å†…å®¹ã€‚-Sï¼šå…³é—­è‡ªåŠ¨æ¢è¡Œï¼ˆé˜²æ­¢é•¿è¡Œè¢«æŠ˜å åˆ°ä¸‹ä¸€è¡Œï¼Œæ¨ªå‘æ»šåŠ¨æŸ¥çœ‹ï¼‰ã€‚
ï¼šè¾“å…¥qé€€å‡º

expr_matrix.txtæ˜¯è¡¨è¾¾é‡

less -S counts/expr_matrix.txt.summary
è¾“å…¥qé€€å‡º

expr_matrix.txt.summaryé‡Œæ˜¯readsåˆ†å¸ƒæƒ…å†µ



